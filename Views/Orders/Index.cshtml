<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Orders LIST </h4>
                <h6>Manage your orders</h6>
            </div>
            <div class="page-btn">
                <a href="/Orders/CreateOrder" class="btn btn-added"><img src="assets/img/icons/plus.svg" class="me-2" alt="img">Add New Orders</a>
                <button class="btn btn-primary" onclick="toggleRequestPopup()">View Requests</button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-top">
                    <div class="search-set">
                        <div class="search-path">
                            <a class="btn btn-filter" id="filter_search">
                                <img src="assets/img/icons/filter.svg" alt="img">
                                <span><img src="assets/img/icons/closes.svg" alt="img"></span>
                            </a>
                        </div>
                        <div class="search-input">
                            <a class="btn btn-searchset">
                                <img src="assets/img/icons/search-white.svg" alt="img">
                            </a>
                        </div>
                    </div>
                    <div class="wordset">
                        <ul>
                            <li>
                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="pdf"><img src="assets/img/icons/pdf.svg" alt="img"></a>
                            </li>
                            <li>
                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="excel"><img src="assets/img/icons/excel.svg" alt="img"></a>
                            </li>
                            <li>
                                <a data-bs-toggle="tooltip" data-bs-placement="top" title="print"><img src="assets/img/icons/printer.svg" alt="img"></a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table datanew" id="ordertable">
                        <thead>
                            <tr>
                                <th>Buyer</th>
                                <th>Seller</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Order Type</th>
                                <th>Amount</th>
                                <th>Product Qty</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model)
                            {
                                <tr>
                                    <td>@order.BuyerName</td>
                                    <td>@order.SellerName</td>
                                    <td>@order.OrderDate</td>
                                    @if (order.OrderStatus == "Pending")
                                    {
                                        <td><span class="badges bg-warning">@order.OrderStatus</span></td>
                                    }
                                    else if (order.OrderStatus == "Success")
                                    {
                                        <td><span class="badges bg-lightgreen">@order.OrderStatus</span></td>
                                    }
                                    else if (order.OrderStatus == "Failed")
                                    {
                                        <td><span class="badges bg-danger">@order.OrderStatus</span></td>
                                    }
                                    <td>@order.OrderType</td>
                                    <td>@order.TotalAmount</td>
                                    <td>@order.TotalQty</td>
                                    <td>
                                        <a class="me-3" href="@Url.Action("Details", "Orders", new { id =  order.OrderId})">
                                            <img src="~/assets/img/icons/eye.svg" alt="img">
                                        </a>
                                        <a class="me-3 confirm-text" href="~/Admins/Delete">
                                            <img src="~/assets/img/icons/delete.svg" alt="img">
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
    }

    .close {
        float: right;
        font-size: 28px;
        cursor: pointer;
    }
</style>

<div id="requestPopup" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="toggleRequestPopup()">&times;</span>
        <h3>Product Requests</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Buyer Shop</th>
                    <th>Total Quantity</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model)
                {
                    @if (order.OrderStatus == "Pending")
                    {
                    <tr>
                        <td>@order.OrderId</td>
                        <td>@order.BuyerId</td>
                        <td>@order.TotalQty</td>
                        <td>@order.TotalAmount</td>
                        <td>@order.OrderStatus</td>
                        <td>
                                <button class="btn btn-warning" onclick="confirmOrder(@order.OrderId)">Update Status</button>
                        </td>
                    </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {

    <script>
        function toggleRequestPopup() {
            var popup = document.getElementById("requestPopup");
            popup.style.display = (popup.style.display === "none" || popup.style.display === "") ? "block" : "none";
        }

        function confirmOrder(orderId) {
            if (confirm("Are you sure you want to mark this order as Success?")) {
                fetch('/Orders/UpdateOrderStatus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId: orderId, newStatus: "Success" })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload(); // Refresh the page after status update
                })
                .catch(error => console.error('Error:', error));
            }
        }
    </script>

}
